export type Mat4 = number[];

export interface CameraIntrinsics {
  fx: number;
  fy: number;
}

export interface CameraPose extends CameraIntrinsics {
  id: number;
  img_name: string;
  width: number;
  height: number;
  position: [number, number, number];
  rotation: [[number, number, number], [number, number, number], [number, number, number]];
}

export const DEFAULT_INTRINSICS: CameraIntrinsics = {
  fx: 1159.5880733038064,
  fy: 1164.6601287484507,
};

export const DEFAULT_CAMERAS: CameraPose[] = [
  {
    id: 0,
    img_name: '00001',
    width: 1959,
    height: 1090,
    position: [-3.0089893469241797, -0.11086489695181866, -3.7527640949141428],
    rotation: [
      [0.876134201218856, 0.06925962026449776, 0.47706599800804744],
      [-0.04747421839895102, 0.9972110940209488, -0.057586739349882114],
      [-0.4797239414934443, 0.027805376500959853, 0.8769787916452908],
    ],
    fy: 1164.6601287484507,
    fx: 1159.5880733038064,
  },
  {
    id: 1,
    img_name: '00009',
    width: 1959,
    height: 1090,
    position: [-2.5199776022057296, -0.09704735754873686, -3.6247725540304545],
    rotation: [
      [0.9982731285632193, -0.011928707708098955, -0.05751927260507243],
      [0.0065061360949636325, 0.9955928229282383, -0.09355533724430458],
      [0.058381769258182864, 0.09301955098900708, 0.9939511719154457],
    ],
    fy: 1164.6601287484507,
    fx: 1159.5880733038064,
  },
  {
    id: 2,
    img_name: '00017',
    width: 1959,
    height: 1090,
    position: [-0.7737533667465242, -0.3364271945329695, -2.9358969417573753],
    rotation: [
      [0.9998813418672372, 0.013742375651625236, -0.0069605529394208224],
      [-0.014268370388586709, 0.996512943252834, -0.08220929105659476],
      [0.00580653013657589, 0.08229885200307129, 0.9965907801935302],
    ],
    fy: 1164.6601287484507,
    fx: 1159.5880733038064,
  },
  {
    id: 3,
    img_name: '00025',
    width: 1959,
    height: 1090,
    position: [1.2198221749590001, -0.2196687861401182, -2.3183162007028453],
    rotation: [
      [0.9208648867765482, 0.0012010625395201253, 0.389880004297208],
      [-0.06298204172269357, 0.987319521752825, 0.14571693239364383],
      [-0.3847611242348369, -0.1587410451475895, 0.9092635249821667],
    ],
    fy: 1164.6601287484507,
    fx: 1159.5880733038064,
  },
  {
    id: 4,
    img_name: '00033',
    width: 1959,
    height: 1090,
    position: [1.742387858893817, -0.13848225198886954, -2.0566370113193146],
    rotation: [
      [0.24669889292141334, -0.08370189346592856, -0.9654706879349405],
      [0.11343747891376445, 0.9919082664242816, -0.05700815184573074],
      [0.9624300466054861, -0.09545671285663988, 0.2541976029815521],
    ],
    fy: 1164.6601287484507,
    fx: 1159.5880733038064,
  },
  {
    id: 5,
    img_name: '00041',
    width: 1959,
    height: 1090,
    position: [3.6567309419223935, -0.16470990600750707, -1.3458085590422042],
    rotation: [
      [0.2341293058324528, -0.02968330457755884, -0.9717522161434825],
      [0.10270823606832301, 0.99469554638321, -0.005638106875665722],
      [0.9667649592295676, -0.09848690996657204, 0.2359360976431732],
    ],
    fy: 1164.6601287484507,
    fx: 1159.5880733038064,
  },
  {
    id: 6,
    img_name: '00049',
    width: 1959,
    height: 1090,
    position: [3.9013554243203497, -0.2597500978038105, -0.8106154188297828],
    rotation: [
      [0.6717235545638952, -0.015718162115524837, -0.7406351366386528],
      [0.055627354673906296, 0.9980224478387622, 0.029270992841185218],
      [0.7387104058127439, -0.060861588786650656, 0.6712695459756353],
    ],
    fy: 1164.6601287484507,
    fx: 1159.5880733038064,
  },
  {
    id: 7,
    img_name: '00057',
    width: 1959,
    height: 1090,
    position: [4.742994605467533, -0.05591660945412069, 0.9500365976084458],
    rotation: [
      [-0.17042655709210375, 0.01207080756938, -0.9852964448542146],
      [0.1165090336695526, 0.9931575292530063, -0.00798543433078162],
      [0.9784581921120181, -0.1161568667478904, -0.1706667764862097],
    ],
    fy: 1164.6601287484507,
    fx: 1159.5880733038064,
  },
  {
    id: 8,
    img_name: '00065',
    width: 1959,
    height: 1090,
    position: [4.34676307626522, 0.08168160516967145, 1.0876221470355405],
    rotation: [
      [-0.003575447631888379, -0.044792503246552894, -0.9989899137764799],
      [0.10770152645126597, 0.9931680875192705, -0.04491693593046672],
      [0.9941768441149182, -0.10775333677534978, 0.0012732004866391048],
    ],
    fy: 1164.6601287484507,
    fx: 1159.5880733038064,
  },
  {
    id: 9,
    img_name: '00073',
    width: 1959,
    height: 1090,
    position: [3.264984351114202, 0.078974937336732, 1.0117200284114904],
    rotation: [
      [-0.026919994628162257, -0.1565891128261527, -0.9872968974090509],
      [0.08444552208239385, 0.983768234577625, -0.1583319754069128],
      [0.9960643893290491, -0.0876350978794554, -0.013259786205163005],
    ],
    fy: 1164.6601287484507,
    fx: 1159.5880733038064,
  },
];

export const DEFAULT_VIEW_MATRIX: Mat4 = [
  0.47, 0.04, 0.88, 0, -0.11, 0.99, 0.02, 0, -0.88, -0.11, 0.47, 0, 0.07, 0.03, 6.55, 1,
];

export function getProjectionMatrix(fx: number, fy: number, width: number, height: number): Mat4 {
  const znear = 0.2;
  const zfar = 200;
  return [
    (2 * fx) / width,
    0,
    0,
    0,
    0,
    -(2 * fy) / height,
    0,
    0,
    0,
    0,
    zfar / (zfar - znear),
    1,
    0,
    0,
    -(zfar * znear) / (zfar - znear),
    0,
  ];
}

export function getViewMatrix(camera: CameraPose): Mat4 {
  const r = camera.rotation.flat();
  const t = camera.position;
  return [
    r[0],
    r[1],
    r[2],
    0,
    r[3],
    r[4],
    r[5],
    0,
    r[6],
    r[7],
    r[8],
    0,
    -t[0] * r[0] - t[1] * r[3] - t[2] * r[6],
    -t[0] * r[1] - t[1] * r[4] - t[2] * r[7],
    -t[0] * r[2] - t[1] * r[5] - t[2] * r[8],
    1,
  ];
}

export function multiply4(a: Mat4, b: Mat4): Mat4 {
  return [
    b[0] * a[0] + b[1] * a[4] + b[2] * a[8] + b[3] * a[12],
    b[0] * a[1] + b[1] * a[5] + b[2] * a[9] + b[3] * a[13],
    b[0] * a[2] + b[1] * a[6] + b[2] * a[10] + b[3] * a[14],
    b[0] * a[3] + b[1] * a[7] + b[2] * a[11] + b[3] * a[15],
    b[4] * a[0] + b[5] * a[4] + b[6] * a[8] + b[7] * a[12],
    b[4] * a[1] + b[5] * a[5] + b[6] * a[9] + b[7] * a[13],
    b[4] * a[2] + b[5] * a[6] + b[6] * a[10] + b[7] * a[14],
    b[4] * a[3] + b[5] * a[7] + b[6] * a[11] + b[7] * a[15],
    b[8] * a[0] + b[9] * a[4] + b[10] * a[8] + b[11] * a[12],
    b[8] * a[1] + b[9] * a[5] + b[10] * a[9] + b[11] * a[13],
    b[8] * a[2] + b[9] * a[6] + b[10] * a[10] + b[11] * a[14],
    b[8] * a[3] + b[9] * a[7] + b[10] * a[11] + b[11] * a[15],
    b[12] * a[0] + b[13] * a[4] + b[14] * a[8] + b[15] * a[12],
    b[12] * a[1] + b[13] * a[5] + b[14] * a[9] + b[15] * a[13],
    b[12] * a[2] + b[13] * a[6] + b[14] * a[10] + b[15] * a[14],
    b[12] * a[3] + b[13] * a[7] + b[14] * a[11] + b[15] * a[15],
  ];
}

export function invert4(a: Mat4): Mat4 | null {
  const b00 = a[0] * a[5] - a[1] * a[4];
  const b01 = a[0] * a[6] - a[2] * a[4];
  const b02 = a[0] * a[7] - a[3] * a[4];
  const b03 = a[1] * a[6] - a[2] * a[5];
  const b04 = a[1] * a[7] - a[3] * a[5];
  const b05 = a[2] * a[7] - a[3] * a[6];
  const b06 = a[8] * a[13] - a[9] * a[12];
  const b07 = a[8] * a[14] - a[10] * a[12];
  const b08 = a[8] * a[15] - a[11] * a[12];
  const b09 = a[9] * a[14] - a[10] * a[13];
  const b10 = a[9] * a[15] - a[11] * a[13];
  const b11 = a[10] * a[15] - a[11] * a[14];
  const det = b00 * b11 - b01 * b10 + b02 * b09 + b03 * b08 - b04 * b07 + b05 * b06;
  if (!det) return null;
  return [
    (a[5] * b11 - a[6] * b10 + a[7] * b09) / det,
    (a[2] * b10 - a[1] * b11 - a[3] * b09) / det,
    (a[13] * b05 - a[14] * b04 + a[15] * b03) / det,
    (a[10] * b04 - a[9] * b05 - a[11] * b03) / det,
    (a[6] * b08 - a[4] * b11 - a[7] * b07) / det,
    (a[0] * b11 - a[2] * b08 + a[3] * b07) / det,
    (a[14] * b02 - a[12] * b05 - a[15] * b01) / det,
    (a[8] * b05 - a[10] * b02 + a[11] * b01) / det,
    (a[4] * b10 - a[5] * b08 + a[7] * b06) / det,
    (a[1] * b08 - a[0] * b10 - a[3] * b06) / det,
    (a[12] * b04 - a[13] * b02 + a[15] * b00) / det,
    (a[9] * b02 - a[8] * b04 - a[11] * b00) / det,
    (a[5] * b07 - a[4] * b09 - a[6] * b06) / det,
    (a[0] * b09 - a[1] * b07 + a[2] * b06) / det,
    (a[13] * b01 - a[12] * b03 - a[14] * b00) / det,
    (a[8] * b03 - a[9] * b01 + a[10] * b00) / det,
  ];
}

export function rotate4(a: Mat4, rad: number, x: number, y: number, z: number): Mat4 {
  const len = Math.hypot(x, y, z);
  if (!len) return a;

  x /= len;
  y /= len;
  z /= len;

  const s = Math.sin(rad);
  const c = Math.cos(rad);
  const t = 1 - c;

  const b00 = x * x * t + c;
  const b01 = y * x * t + z * s;
  const b02 = z * x * t - y * s;
  const b10 = x * y * t - z * s;
  const b11 = y * y * t + c;
  const b12 = z * y * t + x * s;
  const b20 = x * z * t + y * s;
  const b21 = y * z * t - x * s;
  const b22 = z * z * t + c;

  return [
    a[0] * b00 + a[4] * b01 + a[8] * b02,
    a[1] * b00 + a[5] * b01 + a[9] * b02,
    a[2] * b00 + a[6] * b01 + a[10] * b02,
    a[3] * b00 + a[7] * b01 + a[11] * b02,
    a[0] * b10 + a[4] * b11 + a[8] * b12,
    a[1] * b10 + a[5] * b11 + a[9] * b12,
    a[2] * b10 + a[6] * b11 + a[10] * b12,
    a[3] * b10 + a[7] * b11 + a[11] * b12,
    a[0] * b20 + a[4] * b21 + a[8] * b22,
    a[1] * b20 + a[5] * b21 + a[9] * b22,
    a[2] * b20 + a[6] * b21 + a[10] * b22,
    a[3] * b20 + a[7] * b21 + a[11] * b22,
    ...a.slice(12, 16),
  ];
}

export function translate4(a: Mat4, x: number, y: number, z: number): Mat4 {
  return [
    ...a.slice(0, 12),
    a[0] * x + a[4] * y + a[8] * z + a[12],
    a[1] * x + a[5] * y + a[9] * z + a[13],
    a[2] * x + a[6] * y + a[10] * z + a[14],
    a[3] * x + a[7] * y + a[11] * z + a[15],
  ];
}
